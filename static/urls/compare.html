<!doctype html>
<html lang="ru">
<head>
  <title>Сравнение цен</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://localhost:8080/static/css/styles.css">
  <!-- Bootstrap CSS (jsDelivr CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <!-- Bootstrap Bundle JS (jsDelivr CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

</head>
<body>
  <header>
    <a class="site_logo_href" href="https://localhost:8080">
      <div id="site_logo">
        minimal<br>
        delivery<br>
        price
      </div>
    </a>
    <div id="'store_logo">
      сравнение стоимости доставки продуктов
    </div>
  </header>
  <p>Ищем следующий набор продуктов в разных магазинах:</p>
  <div class="product_list">
    <ul id="product_list">
    </ul>
  </div>

  {% if markets_true_set %}    
    {% for set in markets_true_set %}
    {{ set }}
      <div class="compare_list">
        <div class="left">
          <img class='logo_small_size' src='{{ set[0].retailer.appearance.logo_image }}' alt="market_logo">
        </div>
        <div class="center">
          {{ set[-1]}} руб.
        </div>
        <div class="right">
          <a href="https://sbermarket.ru/{{ set[0].retailer.slug }}?sid={{ set[0].store_id }}" 
            class="btn btn-primary" role="button" 
            data-market="{{ set[0].retailer.slug }}" 
            data-store_id="{{ set[0].store_id }}"
            data-legacy_product_id="{{ set[1].product.offer.id }}"
            onclick='doPost(list_offer_product_id(this.dataset.market), 
                            this.dataset.market, 
                            this.dataset.store_id)'>
                              Оформить заказ
          </a>
        </div>
        </div>
      <div class="'hidden" id="{{ set[0].retailer.slug  }}-offer-info">
        {% for item in set[1:-1] %}
          {{ item.product.offer.id }}
        {% endfor %}
      </div>
  <a data-market="{{ set[0].retailer.slug }}"  
   onclick="list_offer_product_id(this.dataset.market)">GO</a>
  {% endfor %}
  {% endif %}
<footer>
  <hr>
  <p>Сервис находится в активной разработке.</p>
  <p>Если вы нашли ошибку или у вас предложения по улучшению работы 
    сервиса напишите на <a href="mailto:mintdragon@yandex.ruu">mintdragon@yandex.ru</a></p>
</footer>

<script type="text/javascript">
  

  async function doPost(list_offer_product_id, market, store_id) {
    // функция отправляет в Сбермаркет продуктовую корзину
    let data = [list_offer_product_id, market, store_id]; 
    alert(data);
      const response = await fetch('https://localhost:8080/push_product_list', {
      //const response = await fetch('https://sbermarket.ru/metro?sid=21', {
      method: 'POST', 
      //referrer: "unsafe-url",
      //cache: "no-cache",
      //mode: "cors", 
      //redirect: "follow",
      headers: {
        /*'authority': 'sbermarket.ru',/
        'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit537.36 (KHTML, like Gecko) Chrome/102.0.5005.115 Safari/537.36", 
        
        'Accept-Language': 'ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7',*/
        'Content-Type': 'application/json;charset=utf-8',
        /*'Cookie': 'external_analytics_anonymous_id=5758d309-2eb8-4150-918a-2caeb474a5e5; _sa=SA1.15af0661-b59b-4ba0-b050-f04859d23f93.1646587275; rl_page_init_referrer=RudderEncrypt%3AU2FsdGVkX18rCloTWnRn58i27u%2FUJ%2FY1a9a4wF45SeU%3D; rl_page_init_referring_domain=RudderEncrypt%3AU2FsdGVkX19vseFUl6lx8uePkSmbgj6oQdek%2BZl60zE%3D; tmr_lvidTS=1646587275689; tmr_lvid=f6559e748095e83af224d8425bda3bfd; iap.uid=30542dc7141047308ab65e950815701a; __exponea_etc__=8ff2a0da-f97b-42a8-8173-a0624c197909; _ym_d=1647752179; _ym_uid=1647752179354959655; top100_id=t1.7588506.1602808230.1650559746089; adtech_uid=c38b2303-daa8-4b91-a9fc-06837831b585%3Asbermarket.ru; t2_sid_7588506=s1.1353085490.1650562333155.1650563310429.2.44.51; city_info=%7B%22slug%22%3A%22izhevsk%22%2C%22name%22%3A%22%D0%98%D0%B6%D0%B5%D0%B2%D1%81%D0%BA%22%2C%22lat%22%3A56.8489%2C%22lon%22%3A53.2316%7D; _pk_id.6.3ec0=312ace8500040915.1655394834.; _pk_ses.6.3ec0=1; _gcl_au=1.1.2125858253.1655394835; __exponea_time2__=-1.8796436786651611; rrpvid=57; _gid=GA1.2.1617690732.1655394836; siteEntryTime=Thu%20Jun%2016%202022%2019%3A53%3A56%20GMT%2B0400%20(%D0%A1%D0%B0%D0%BC%D0%B0%D1%80%D1%81%D0%BA%D0%BE%D0%B5%20%D1%81%D1%82%D0%B0%D0%BD%D0%B4%D0%B0%D1%80%D1%82%D0%BD%D0%BE%D0%B5%20%D0%B2%D1%80%D0%B5%D0%BC%D1%8F); rcuid=62ab5212ae90740001d55314; _ym_isad=1; user-id_1.0.5_lr_lruid=pQ8AAAKLYWLQgU47AdY%2B0wA%3D; identified_address=true; sessionId=16553983972895361606; _ym_visorc=b; reachedTimer=1; _gat_UA-136687175-2=1; _gat_%5Bobject%20Object%5D=1; _808db7ba1248=%5B%7B%22source%22%3A%22localhost%22%2C%22medium%22%3A%22referral%22%2C%22cookie_changed_at%22%3A1655398395%7D%2C%7B%22source%22%3A%22%28direct%29%22%2C%22medium%22%3A%22%28none%29%22%2C%22cookie_changed_at%22%3A1655394830%7D%2C%7B%22source%22%3A%22sbermarket.ru%22%2C%22medium%22%3A%22referral%22%2C%22cookie_changed_at%22%3A1655399572%7D%5D; rl_group_id=RudderEncrypt%3AU2FsdGVkX1%2B9AmD3SahRPiL9EnREfNkPhmXfNEIKfIw%3D; rl_group_trait=RudderEncrypt%3AU2FsdGVkX18%2BRg%2BBnnhB81N44Iu4br7%2Fu9L1YoJsIto%3D; rl_anonymous_id=RudderEncrypt%3AU2FsdGVkX19B%2F268rNARUYEJV9a4ABJzWikr466Nr894Uy1Q7xH%2FBgV03%2FaSS9RyPm6j025O8%2Bj5wHV%2FlZvgcg%3D%3D; pageviewCount=8; rl_user_id=RudderEncrypt%3AU2FsdGVkX18sUeBVcQo8V8RMOb2Z9WpubbfpNcQ6ry0%3D; rl_trait=RudderEncrypt%3AU2FsdGVkX1%2FNX2CZYRhSP%2B9h3RH%2B1GGjyk0HCa7gjMaQL3f4eazTdD3AW%2BAnEg5yIz%2FcI1wrN26hgBQbaRozebVBX0tFrfk4OB7rscKbXTu2tepdnJkCbN4iFXYKgThAnaNERk1xLKxrYD3T42HNbcwSxGkNmBlUoghyggCCKFVs%2F6SLYWQkf24O9vF%2FxH%2Bp; _ga_XVJWMHHXNJ=GS1.1.1655398402.8.1.1655399578.0; _ga_9QYWDVGJZ3=GS1.1.1655398402.8.1.1655399578.27; last_visit=1655385178399%3A%3A1655399578399; t3_sid_7588506=s1.964788168.1655398402637.1655399578412.2.5.15.1; tmr_detect=1%7C1655399578655; tmr_reqNum=282; _ga=GA1.2.1127956436.1646587276; _Instamart_session=RjJaV3dic1ZzMEpNN2MzcDZncUl3b0NOa0crSFc4bzFjMk93WVA5VzdyVElFQUlCck82OUhESFBzbnpRcVB3Ry9oUktkUXdBWnZDMUpEeGVZNEdxTGwySnByYitwbWFjdnVHOGhzZS80S2JxaFVLeHZPb0FGTHRaYW1ZN1oxOERPL1JUamZmNWloc0VCcEFDUVhCVFdLMGRtUlJ4MEZRUmRSbXdjSWhIa0wrakNjNk90aGtCSE5KcVlSYkJhbUpPVGVHaDNySmltNElwaEo0cDkzZTA3QT09LS05T0VJS0JUNy9hMVVoOWRPdFdHYm9BPT0%3D--75785b557110a2b832b0e4ef96eb962cd2b6203a',
        'Origin': 'https://sbermarket.ru',
        'sec-ch-ua': "\" Not A;Brand\";v=\"99\", \"Chromium\";v=\"102\", \"Google Chrome\";v=\"102\"",
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-platform": "\"Windows\"",
        "x-csrf-token": "7mjWIwQbi/Nrlrb8K9441iPT4PghO62DgYXNTlPGy9N3K9koXACDBsKnIc/Gogg75yz67LlRLJZKABI03GjeOA==",
        'Referer': 'https://sbermarket.ru/metro?sid=21',
        'Sec-Fetch-Dest': 'empty', 
        'Sec-Fetch-Mode': 'cors', 
        'Sec-Fetch-Site': 'same-origin',*/
      },
      //body: JSON.stringify("{\"shopping_context\":{\"shipping_method_kind\":\"by_courier\",\"ship_address\":{\"id\":99895646,\"full_address\":\"Москва, Тверская улица, 13\",\"city\":\"Москва\",\"street\":\"Тверская улица\",\"building\":\"13\",\"block\":null,\"floor\":null,\"apartment\":null,\"entrance\":null,\"elevator\":null,\"region\":null,\"comments\":null,\"phone\":null,\"area\":null,\"settlement\":null,\"lat\":55.761259,\"lon\":37.609119,\"city_kladr_id\":null,\"street_kladr_id\":null,\"user_id\":null,\"door_phone\":null,\"kind\":\"home\",\"delivery_to_door\":false}}}")
      body: JSON.stringify(data)
  }).then((response) => {
    console.log(response);
  })
  }
</script>

<script src="https://localhost:8080/static/scripts/product_list.js" 
  type="text/javascript">
</script>
<script>
  
  
  let cart = JSON.parse(sessionStorage.getItem("cart_list"));
  console.log(cart);

  function list_offer_product_id(market) {
    // Функция возвращает массив с offer_id для market
    let data = document.getElementById(market+"-offer-info").innerText;
    data = data.split(' ');
    return data;
  }

  let ul  = document.getElementById('product_list');
  // отрисовываем список продуктов из корзины
    for (product in cart) {    
    let li = document.createElement('li');
    li.innerHTML = `${cart[product].name}`;
    ul.appendChild(li);
    }
  
    
</script>
</body>
</html>